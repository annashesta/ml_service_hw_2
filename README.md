# ML Fraud Detection Service with Docker image

К сервису  https://github.com/annashesta/ml_service_hw_1
Создан Docker image на https://hub.docker.com/repository/

**DISCLAIMER**

Сервис подготовлен в демонстрационных целях в рамках занятий по MLOps.  
Датасеты предоставлены в рамках соревнования [Teta ML-1 2025](https://www.kaggle.com/competitions/teta-ml-1-2025).  

Сервис для автоматического обнаружения мошеннических транзакций в режиме батчевого скоринга. Обрабатывает CSV-файлы из указанной директории с использованием предобученной модели CatBoost. Результаты сохраняются в выходной директории.

---

## Архитектура решения

```
ml_service/
├── input/                     # Директория для входных файлов (test.csv)
├── output/                    # Директория для выходных файлов
├── app/(app.py)               # Основной скрипт приложения
├── src/                       # Исходный код сервиса
│   ├── preprocess.py          # Препроцессинг данных
│   ├── scorer.py              # Инференс модели
│   ├── feature_importance.py  # Выгрузка важности признаков
│   └── plot_predictions.py    # Построение графика плотности предсказаний
├── model/                     # Модель и артефакты
│   ├── catboost_model.cbm     # Сохраненная модель CatBoost
│   ├── threshold.json         # Порог классификации
│   └── categorical_features.json  # Список категориальных признаков
├── train_data/(train.csv)     # Тренировочный датасет
├── config.yaml                # Конфигурационный файл
├── requirements.txt           # Зависимости Python
├── Dockerfile                 # Файл для сборки Docker-образа
├── .dockerignore              # Файл для исключения ненужных файлов
├── train_model.py             # Файл jupyter notebook с кодом обучения модели
│                              # для возможных изменений
└── README.md                  # Инструкция по использованию сервиса
```

---

## Ключевые особенности

### 1. **Автоматическая обработка категориальных признаков**
- Категориальные признаки передаются в модель CatBoost напрямую через параметр `cat_features`.
- Ручное кодирование категориальных признаков не требуется.

### 2. **Пайплайн обработки данных**
1. **Временные признаки:**
   - Извлечение часа, года, месяца, дня месяца, дня недели.
   - Удаление исходного timestamp (`transaction_time`).

2. **Геопространственные расчеты:**
   - Расчет расстояния (в километрах) между клиентом и продавцом с использованием библиотеки `geopy`.

3. **Числовые признаки:**
   - Обработка пропущенных значений с использованием стратегии средних значений.
   - Логарифмическое преобразование числовых признаков.
   - Масштабирование числовых признаков.

4. **Удаление ненужных колонок:**
   - Удаляются колонки, такие как `name_1`, `name_2`, `street`, `post_code`.

### 3. **Модельный слой**
- Используется модель CatBoostClassifier.
- Порог классификации загружается из файла `threshold.json`.
- Автоматическая загрузка модели при инициализации.
- Батчевая обработка через `predict_proba`.

### 4. **Дополнительные функции**
- **Выгрузка важности признаков:** Сохраняет топ-5 важных признаков в файл `feature_importance.json`.
- **График плотности предсказаний:** Строит график плотности предсказаний и сохраняет его в файл `predictions_distribution.png`.

---

## Быстрый старт

### Требования
- Python 3.8+
- Docker 20.10+
- 2 ГБ свободного места
- Порты: только файловая система

### Запуск сервиса

1. **Скачайте файл `train.csv`:**
   - Скачайте файл из соревнования [Teta ML-1 2025](https://www.kaggle.com/competitions/teta-ml-1-2025) и разместите его в директории `./train_data`.

2. **Склонируйте репозиторий:**
   ```bash
   git clone https://github.com/yourusername/ml_service.git
   cd ml_service
   ```

3. **Соберите Docker-образ:**
   ```bash
   docker build -t fraud_detector .
   ```

4. **Запустите контейнер с монтированием томов:**
   ```bash
   docker run -it --rm \
    -v "$(pwd)/input:/app/input" \
    -v "$(pwd)/output:/app/output" \
    -v "$(pwd)/model:/app/model" \
    fraud_detector
   ```

   - `-v` монтирует хостовые директории в контейнер
   -  Пути должны быть абсолютными и без пробелов
   - Права доступа соответствуют хостовой системе

5. **После запуска сервиса:**
   - Разместите файл формата `test.csv` в директории `./input`.
   - Подождите выполнения препроцессинга и скоринга датасета.
   - Результаты будут сохранены в директории `./output`:
     - Предсказания: `predictions_<timestamp>.csv`
     - Важность признаков: `feature_importance.json`
     - График плотности предсказаний: `predictions_distribution.png`

---

### Просмотр логов

Логи сервиса сохраняются в файле `/app/logs/service.log` внутри контейнера. Вы можете просматривать их следующими способами:

1. **Использование команды `docker logs`:**
   ```bash
   docker logs <container_id>
   ```

2. **Монтирование директории логов на хост-систему:**
   ```bash
   docker run -it --rm \
       -v $(pwd)/input:/app/input \
       -v $(pwd)/output:/app/output \
       -v $(pwd)/logs:/app/logs \
       fraud_detector
   ```

---

### Зависимости

Смотрите файл `requirements.txt`.

---

### Для повторного обучения модели

1. **Скачайте файл `train.csv`:**
   - Скачайте файл из соревнования [Teta ML-1 2025](https://www.kaggle.com/competitions/teta-ml-1-2025) и разместите его в директории `./train_data`.

2. **Запустите скрипт `train_model.py`:**
   ```bash
   python train_model.py
   ```

3. **Результаты обучения:**
   - Модель: `./model/catboost_model.cbm`
   - Порог: `./model/threshold.json`
   - Список категориальных признаков: `./model/categorical_features.json`

---

### Лицензия

MIT License
